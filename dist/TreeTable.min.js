!function(a){"use strict";var b=a.module("net.enzey.treetable",[]),c=function(){var a=[];a.contains=function(a){return-1===this.indexOf(a)?!1:!0};var b=a.push;return a.push=function(a){this.contains(a)||b.call(this,a)},a.remove=function(a){var b=this.indexOf(a);this.contains(a)&&this.splice(b,1)},a},d=function(a,b){for(var c=[],d=Object.keys(a),e=0;e<d.length;e++)b[d[e]]||c.push(a[d[e]]);return c};b.directive("nzTreetable",["$parse","$sce","$timeout","$filter",function(b,e,f,g){return{scope:!0,compile:function(e){e.find("tr").attr("ng-repeat","row in treeTableObjDisplayArray | limitTo: 300");var f={parentNodeId:"parentId",childNodeId:"childId",nodeId:"id"};return{pre:function(e,h,i){var j="";e.treeTableObjDisplayArray=[];var k="",l=b(i.getChildrenFn)(e);a.isDefined(i.parentNodeId)&&(f.parentNodeId=b(i.parentNodeId)(e));var m=b(f.parentNodeId);a.isDefined(i.childNodeId)&&(f.childNodeId=b(i.childNodeId)(e));var n=b(f.childNodeId);a.isDefined(i.nodeId)&&(f.nodeId=b(i.nodeId)(e));var o=b(f.nodeId);a.isDefined(i.orderBy)&&i.$observe("orderBy",function(a){k=a,e.buildTreeTable()});var p,q;b(i.getInitial)(e)().then(function(a){p=a.links,q=a.nodes,e.buildTreeTable()});var r=c();e.collapseRow=function(b){t[b.id]=a.extend({},t[b.id]),r.contains(b.id)||(r.push(b.id),e.buildTreeTable())};var s=function(a){var b=o(a),c=[];return Object.keys(t).forEach(function(a){o(t[a].node)===b&&c.push(a)}),c};e.expandRow=function(b){if(!b.isLoading){if(t[b.id]=a.extend({},t[b.id]),b.hasChildren&&!r.contains(b.id)){b.isLoading=!0;var c=s(b.node);c.forEach(function(c){t[c]=a.extend({},t[c]),t[c].isLoading=!0,t[c].id!==b.id&&r.push(t[c].id)}),l(b.node).then(function(d){d&&(p.push.apply(p,d.links),q.push.apply(q,d.nodes),c.forEach(function(c){t[c]=a.extend({},t[c]),t[c].isLoading=!1,t[c].id!==b.id&&r.push(t[c].id)}),b.isLoading=!1,r.remove(b.id),e.buildTreeTable())})}else r.remove(b.id);e.buildTreeTable()}};var t={};e.buildTreeTable=function(){if(q&&p){{new Date}e.treeTableObjDisplayArray.length=0;var b={};q.forEach(function(a){b[o(a)]=a});var c={},f={};p.forEach(function(a){var d=m(a);b[d]&&(c[d]||(c[d]=[]),c[d].push(a));var e=n(a);b[e]&&(f[e]||(f[e]=[]),f[e].push(a))});var h;h=function(d){var e=o(d.node);if(d.id?d.id+=j+e+j+d.link.id:d.id=e+j+"root",t[d.id]&&(t[d.id].children=null,d.isLoading=t[d.id].isLoading,d=a.extend(t[d.id],d)),r.contains(d.id))d.hasChildren=!0,d.isExpanded=!1;else{var f=c[e];f&&(d.children=[],f.forEach(function(a){var c=b[n(a)];c&&d.children.push(h({node:c,link:a,level:d.level+1,id:d.id,parent:d}))})),d.children&&(d.hasChildren=!0,d.children.length>0&&(d.isExpanded=!0))}return d};var i=d(b,f),l=[];i.forEach(function(a){l.push(h({node:a,link:null,level:0}))});var s,u=g("orderBy"),v=!1;s=function(a){t[a.id]=a,e.treeTableObjDisplayArray.push(a),a.children&&(a.children=u(a.children,k,v),a.children.forEach(function(a){s(a)}))},l=u(l,k,v),l.forEach(s);{new Date}}}}}}}}]),b.directive("treetableIndent",["$compile",function(b){return{link:{post:function(c,d){var e=a.element('<div style="padding-left: '+c.row.level+'em; padding-right: 1em; display: inline;"></div>'),f=a.element('<div style="display: inline; border-radius: 100%; font-weight: bold; font-size: 1em; cursor: pointer"></div>');c.row.hasChildren?c.row.isLoading?f.text("⏰"):c.row.isExpanded?(f.text("˅"),f.attr("ng-click","collapseRow(row)")):(f.text("˃"),f.attr("ng-click","expandRow(row)")):(f.text("˅"),f.css("visibility","none"),f.css("opacity","0")),e.append(f),d.prepend(b(e)(c))}}}}])}(angular);